<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>AiSQLSearcher 测试台</title>
    <style>
        body {
            font-family: Segoe UI, Arial, sans-serif;
            margin: 18px;
            background: #f7f9fc;
            color: #222;
        }

        h1 {
            margin: 0 0 18px;
            font-size: 22px;
        }

        h2 {
            margin: 0 0 10px;
            font-size: 17px;
        }

        .panel {
            background: #fff;
            padding: 14px 16px;
            border: 1px solid #e2e6eb;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .04);
        }

        label {
            font-size: 13px;
            color: #555;
            margin-bottom: 4px;
            display: block;
        }

        textarea, input[type=text] {
            width: 100%;
            box-sizing: border-box;
            font-family: Consolas, monospace;
            font-size: 13px;
            padding: 8px 10px;
            border: 1px solid #c7ccd1;
            border-radius: 4px;
            resize: vertical;
            min-height: 70px;
            background: #fff;
        }

        textarea:focus, input:focus {
            outline: none;
            border-color: #409eff;
            box-shadow: 0 0 0 2px rgba(64, 158, 255, .18);
        }

        button {
            background: #409eff;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 7px 16px;
            cursor: pointer;
            font-size: 13px;
            margin-right: 6px;
        }

        button.secondary {
            background: #67c23a;
        }

        button.warn {
            background: #e6a23c;
        }

        button:disabled {
            background: #b3c0d1;
            cursor: not-allowed;
        }

        .small {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }

        pre {
            background: #1e1e1e;
            color: #e6e6e6;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.45;
            overflow: auto;
            max-height: 320px;
            margin-top: 10px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .error-border {
            border: 1px solid #f56c6c !important;
        }

        .ok-tag {
            color: #67c23a;
            font-weight: 600;
        }

        .fail-tag {
            color: #f56c6c;
            font-weight: 600;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .flex {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .inline-json {
            background: #fafafa;
            border: 1px solid #e3e3e3;
            font-family: Consolas, monospace;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .time {
            font-size: 12px;
            color: #999;
            margin-left: 6px;
        }

        .footer {
            margin-top: 30px;
            font-size: 12px;
            text-align: center;
            color: #888;
        }
    </style>
</head>
<body>
<header>
    <h1>AiSQLSearcher 测试台</h1>
    <div id="healthBox">Health: <span id="healthText">检测中...</span></div>
</header>

<div class="panel" id="panelQuery">
    <h2>Query 测试 (POST /AiSQLSearcher/query)</h2>
    <div class="small">请求体: <span class="inline-json">{ "question": "...", "run": true/false }</span></div>
    <label for="qQuestion">Question</label>
    <textarea id="qQuestion" placeholder="例如：展示最近 20 条订单"></textarea>
    <div class="flex" style="margin:8px 0 4px;">
        <label style="display:flex;align-items:center;gap:4px;font-size:12px;">
            <input id="qRunFlag" type="checkbox"> run=true
        </label>
        <button id="btnQuery">发送 Query</button>
        <button class="warn" id="btnQueryClear" type="button">清空结果</button>
        <span class="time" id="qTime"></span>
    </div>
    <pre hidden id="qResult"></pre>
</div>

<div class="panel" id="panelRun">
    <h2>Run 测试 (POST /AiSQLSearcher/run)</h2>
    <div class="small">请求体: <span class="inline-json">{ "question": "..." }</span> 返回: <span class="inline-json">{ "sql":"...", "data":[...], "error":null }</span>
    </div>
    <label for="rQuestion">Question</label>
    <textarea id="rQuestion" placeholder="例如：展示最近 20 条订单"></textarea>
    <div class="flex" style="margin:8px 0 4px;">
        <button class="secondary" id="btnRun">执行 Run</button>
        <button class="warn" id="btnRunClear" type="button">清空结果</button>
        <button id="btnFillDemo" type="button">填充示例</button>
        <span class="time" id="rTime"></span>
    </div>
    <pre hidden id="rResult"></pre>
</div>

<div class="panel">
    <h2>调试 / 日志</h2>
    <div class="small">显示最近请求耗时、URL、状态码。</div>
    <pre id="logBox" style="max-height:180px;"></pre>
    <button class="warn" id="btnClearLog" style="margin-top:6px;" type="button">清空日志</button>
</div>

<div class="footer">
    同��静态测试页 | 若一直 404：确认 FastAPI /health /api/sql/query /api/sql/run 是否存在以及跨容器网络配置
</div>

<script>
    const healthText = document.getElementById('healthText');
    const logBox = document.getElementById('logBox');

    function logLine(msg) {
        const ts = new Date().toISOString().substring(11, 23);
        logBox.textContent = `[${ts}] ${msg}\n` + logBox.textContent;
    }

    async function checkHealth() {
        try {
            const start = performance.now();
            const r = await fetch('/AiSQLSearcher/health');
            const raw = await r.text();
            let j;
            try {
                j = JSON.parse(raw);
            } catch {
                j = {raw};
            }
            const ms = (performance.now() - start).toFixed(1);
            if (r.ok) {
                healthText.textContent = `OK (debug=${j.debug ?? 'NA'})`;
                healthText.className = 'ok-tag';
            } else {
                healthText.textContent = 'FAILED(' + r.status + ')';
                healthText.className = 'fail-tag';
            }
            logLine(`HEALTH status=${r.status} ${ms}ms body=${raw.slice(0, 140)}`);
        } catch (e) {
            healthText.textContent = 'FAILED';
            healthText.className = 'fail-tag';
            logLine('HEALTH 调用异常: ' + e.message);
        }
    }

    function pretty(o) {
        return JSON.stringify(o, null, 2);
    }

    async function postJson(path, body) {
        const url = path;
        const start = performance.now();
        let status = 0, text = '';
        try {
            const r = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            status = r.status;
            text = await r.text();
            const ms = (performance.now() - start).toFixed(1);
            let parsed;
            try {
                parsed = JSON.parse(text);
            } catch {
                parsed = {raw: text};
            }
            logLine(`POST ${url} ${status} ${ms}ms req=${JSON.stringify(body)} respLen=${text.length}`);
            if (!r.ok) {
                return {status, error: parsed.error || parsed.raw || ('HTTP ' + status)};
            }
            return parsed;
        } catch (e) {
            const ms = (performance.now() - start).toFixed(1);
            logLine(`POST ${url} EXCEPTION ${ms}ms msg=${e.message}`);
            return {status, error: e.message || 'NETWORK_ERROR'};
        }
    }

    function render(pre, obj) {
        pre.hidden = false;
        if (obj && obj.error) {
            pre.classList.add('error-border');
        } else {
            pre.classList.remove('error-border');
        }
        pre.textContent = pretty(obj);
    }

    // Query
    document.getElementById('btnQuery').addEventListener('click', async () => {
        const question = document.getElementById('qQuestion').value.trim();
        const run = document.getElementById('qRunFlag').checked;
        if (!question) {
            alert('请输入 question');
            return;
        }
        const btn = document.getElementById('btnQuery');
        const timeEl = document.getElementById('qTime');
        btn.disabled = true;
        btn.textContent = '请求中...';
        timeEl.textContent = '';
        const t0 = performance.now();
        const resp = await postJson('/AiSQLSearcher/query', {question, run});
        const dur = (performance.now() - t0).toFixed(1);
        timeEl.textContent = dur + ' ms';
        render(document.getElementById('qResult'), resp);
        btn.disabled = false;
        btn.textContent = '发送 Query';
    });

    document.getElementById('btnQueryClear').addEventListener('click', () => {
        document.getElementById('qResult').hidden = true;
        document.getElementById('qResult').textContent = '';
        document.getElementById('qTime').textContent = '';
    });

    // Run
    document.getElementById('btnRun').addEventListener('click', async () => {
        const question = document.getElementById('rQuestion').value.trim();
        if (!question) {
            alert('请输入 question');
            return;
        }
        const btn = document.getElementById('btnRun');
        const timeEl = document.getElementById('rTime');
        btn.disabled = true;
        btn.textContent = '执行中...';
        timeEl.textContent = '';
        const t0 = performance.now();
        const resp = await postJson('/AiSQLSearcher/run', {question});
        const dur = (performance.now() - t0).toFixed(1);
        timeEl.textContent = dur + ' ms';
        render(document.getElementById('rResult'), resp);
        btn.disabled = false;
        btn.textContent = '执行 Run';
    });

    document.getElementById('btnRunClear').addEventListener('click', () => {
        document.getElementById('rResult').hidden = true;
        document.getElementById('rResult').textContent = '';
        document.getElementById('rTime').textContent = '';
    });

    document.getElementById('btnFillDemo').addEventListener('click', () => {
        document.getElementById('qQuestion').value = '展示最近 20 条订单';
        document.getElementById('rQuestion').value = '展示最近 20 条订单';
    });

    document.getElementById('btnClearLog').addEventListener('click', () => logBox.textContent = '');

    checkHealth();
    setInterval(checkHealth, 15000);
</script>
</body>
</html>
